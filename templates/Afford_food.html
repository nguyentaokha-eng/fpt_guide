{% extends "base.html" %}
{% load static %}
{% block content %}

<style>
body{background:#0b1220;color:#e5e7eb}
.container{max-width:1200px;margin:auto}

/* SEARCH */
.search-box{max-width:600px;margin:30px auto}
.search-box input{
 width:100%;padding:14px 20px;border-radius:999px;
 border:none;outline:none;font-size:1rem
}

/* LIST */
.grid{
 display:grid;
 grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
 gap:20px
}
.card{
 background:#111827;border-radius:16px;
 overflow:hidden;cursor:pointer;transition:.25s
}
.card:hover{transform:translateY(-6px)}
.card img{width:100%;height:170px;object-fit:cover}
.card-body{padding:14px}
.card-body small{color:#9ca3af}

/* OVERLAY */
.overlay{
 position:fixed;inset:0;
 background:rgba(0,0,0,.8);
 display:none;align-items:center;justify-content:center;
 z-index:999
}
.modal{
 width:90%;max-width:1100px;
 background:#020617;border-radius:18px;
 display:grid;grid-template-columns:1.1fr .9fr;
 overflow:hidden
}
.left,.right{padding:20px}
.main-img{width:100%;height:260px;object-fit:cover;border-radius:12px}
.gallery{display:flex;gap:8px;margin-top:10px}
.gallery img{
 width:70px;height:70px;object-fit:cover;
 border-radius:8px;cursor:pointer
}

/* SCORE */
.score-grid{
 display:grid;grid-template-columns:repeat(2,1fr);
 gap:8px;margin:12px 0
}
.score-grid div{
 background:#111827;padding:8px;border-radius:8px
}

/* COMMENT */
.comment{background:#111827;padding:10px;border-radius:10px;margin-top:10px}
.comment img{width:60px;height:60px;object-fit:cover;border-radius:8px}
.comment-imgs{display:flex;gap:5px;margin-top:8px}
.comment-imgs img{width:50px;height:50px;border-radius:6px;cursor:pointer}

/* ZOOM */
#zoom{
 position:fixed;inset:0;
 background:rgba(0,0,0,.85);
 display:none;align-items:center;justify-content:center;
 z-index:2000
}
#zoom img{max-width:90%;max-height:90%}

/* FORM */
.form-group{margin-bottom:10px}
.form-group input,.form-group textarea{width:100%;padding:8px;border-radius:6px;border:none;background:#374151}
.form-group label{font-size:12px;color:#9ca3af}
</style>

<div class="container">
 <h3 class="mt-4">üçú ƒÇn u·ªëng quanh ƒêH FPT</h3>

 <div class="search-box">
  <input id="search" placeholder="c∆°m r·∫ª, cafe h·ªçc b√†i, ch·ª£ sinh vi√™n...">
 </div>

 <div class="grid" id="list"></div>
</div>

<!-- DETAIL -->
<div class="overlay" id="detail">
 <div class="modal">
  <div class="left">
   <h4 id="dName"></h4>
   <a id="dMap" target="_blank">üìç Google Maps</a>
   <p>‚≠ê <b id="dAvg"></b> / 10</p>

   <div class="score-grid">
    <div>Gi√°: <span id="sPrice"></span></div>
    <div>Ch·∫•t l∆∞·ª£ng: <span id="sQuality"></span></div>
    <div>Ph·ª•c v·ª•: <span id="sService"></span></div>
    <div>Kh√¥ng gian: <span id="sSpace"></span></div>
   </div>

   <img id="dMain" class="main-img">
   <div class="gallery" id="dGallery"></div>
  </div>

  <div class="right">
   <h5>B√¨nh lu·∫≠n sinh vi√™n</h5>
   <div id="commentList"></div>
   
   <!-- COMMENT FORM -->
   <div style="margin-top:20px;padding:15px;background:#1f2937;border-radius:12px">
    <h6>Th√™m b√¨nh lu·∫≠n</h6>
    {% csrf_token %}
    <div class="form-group">
     <input id="cName" placeholder="T√™n c·ªßa b·∫°n">
    </div>
    <div class="form-group">
     <textarea id="cText" placeholder="Chia s·∫ª tr·∫£i nghi·ªám..." rows="3"></textarea>
    </div>
    <div class="form-group" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
     <div><label>Gi√°</label><input type="number" id="cPrice" min="1" max="10" value="5"></div>
     <div><label>Ch·∫•t l∆∞·ª£ng</label><input type="number" id="cQuality" min="1" max="10" value="5"></div>
     <div><label>Ph·ª•c v·ª•</label><input type="number" id="cService" min="1" max="10" value="5"></div>
     <div><label>Kh√¥ng gian</label><input type="number" id="cSpace" min="1" max="10" value="5"></div>
    </div>
    <div class="form-group">
     <label>·∫¢nh (c√≥ th·ªÉ ch·ªçn nhi·ªÅu)</label>
     <input type="file" id="cImages" multiple accept="image/*">
    </div>
    <label><input type="checkbox" id="cAnon"> ·∫®n danh</label>
    <br><br>
    <button onclick="submitComment()" style="background:#3b82f6;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;width:100%">G·ª≠i b√¨nh lu·∫≠n</button>
   </div>
  </div>
 </div>
</div>

<div id="zoom" onclick="this.style.display='none'">
 <img id="zoomImg">
</div>

<script>
const DATA=[
{
 id:1,
 name:"Qu√°n c∆°m c√¥ ƒê·∫πp",
 map:"https://maps.google.com",
 tags:["c∆°m","r·∫ª","no"],
 keywords:["ƒÉn no","35k","25k","sinh vi√™n"],
 photos:{
  place:[
   "https://images.foody.vn/res/g1/123/prof/s640x400.jpg",
   "https://images.foody.vn/res/g1/123/s640x400.jpg"
  ]
 },
 ratings:[{price:9,quality:8,service:7,space:6}],
 comments:[
  {user:"·∫®n danh",text:"R·∫ª th·∫≠t, ƒÉn no",img:"https://i.pravatar.cc/100?1"}
 ]
},
{
 id:2,
 name:"Cafe H·ªçc B√†i 24h",
 map:"https://maps.google.com",
 tags:["cafe","y√™n tƒ©nh"],
 keywords:["h·ªçc b√†i","wifi","ƒë√™m"],
 photos:{place:[
  "https://images.foody.vn/res/g2/456/prof/s640x400.jpg"
 ]},
 ratings:[{price:7,quality:8,service:8,space:9}],
 comments:[]
},
{
 id:3,
 name:"Ch·ª£ Sinh Vi√™n",
 map:"https://maps.google.com",
 tags:["ch·ª£","r·∫ª"],
 keywords:["ƒÉn v·∫∑t","ti·∫øt ki·ªám"],
 photos:{place:[
  "https://images.foody.vn/res/g3/789/prof/s640x400.jpg"
 ]},
 ratings:[{price:10,quality:7,service:6,space:6}],
 comments:[]
},
{
 id:4,
 name:"B√∫n b√≤ Hu·∫ø",
 map:"https://maps.google.com",
 tags:["b√∫n","no"],
 keywords:["ƒÉn s√°ng","n√≥ng"],
 photos:{place:[
  "https://images.foody.vn/res/g4/321/prof/s640x400.jpg"
 ]},
 ratings:[{price:8,quality:9,service:7,space:7}],
 comments:[]
},
{
 id:5,
 name:"Tr√† s·ªØa gi√° sinh vi√™n",
 map:"https://maps.google.com",
 tags:["tr√† s·ªØa","r·∫ª"],
 keywords:["ng·ªçt","chill"],
 photos:{place:[
  "https://images.foody.vn/res/g5/654/prof/s640x400.jpg"
 ]},
 ratings:[{price:8,quality:7,service:8,space:8}],
 comments:[]
}
];

function avg(p){
 let t={price:0,quality:0,service:0,space:0};
 p.ratings.forEach(r=>Object.keys(t).forEach(k=>t[k]+=r[k]));
 Object.keys(t).forEach(k=>t[k]/=p.ratings.length||1);
 return t;
}

function render(){
 const q=search.value.toLowerCase();
 list.innerHTML="";
 DATA.filter(p=>{
  if(!q)return true;
  return p.name.toLowerCase().includes(q)
   || p.tags.some(t=>q.includes(t))
   || p.keywords.some(k=>q.includes(k));
 }).forEach(p=>{
  const a=avg(p);
  list.innerHTML+=`
   <div class="card" onclick="openDetail(${p.id})">
    <img src="${p.photos.place[0]}">
    <div class="card-body">
     <h5>${p.name}</h5>
     <small>‚≠ê ${((a.price+a.quality+a.service+a.space)/4).toFixed(1)}</small>
    </div>
   </div>`;
 });
}

let currentPlaceId = null;

function openDetail(id){
 const p=DATA.find(x=>x.id===id);
 currentPlaceId = id;
 detail.style.display="flex";
 const a=avg(p);

 dName.innerText=p.name;
 dMap.href=p.map;
 dAvg.innerText=((a.price+a.quality+a.service+a.space)/4).toFixed(1);
 sPrice.innerText=a.price.toFixed(1);
 sQuality.innerText=a.quality.toFixed(1);
 sService.innerText=a.service.toFixed(1);
 sSpace.innerText=a.space.toFixed(1);

 dMain.src=p.photos.place[0];
 dGallery.innerHTML="";
 p.photos.place.forEach(i=>{
  dGallery.innerHTML+=`<img src="${i}" onclick="zoomImg.src='${i}';zoom.style.display='flex'">`;
 });

 // Load comments from backend
 loadComments(id);
}

function loadComments(placeId){
 fetch(`/comment/list/${placeId}/`)
 .then(r=>r.json())
 .then(data=>{
  commentList.innerHTML="";
  data.forEach(c=>{
   let imgsHtml = "";
   if(c.images && c.images.length > 0){
    imgsHtml = `<div class="comment-imgs">` + 
     c.images.map(img=>`<img src="${img}" onclick="zoomImg.src='${img}';zoom.style.display='flex'">`).join('') + 
     `</div>`;
   }
   commentList.innerHTML+=`
    <div class="comment">
     <b>${c.user}</b>
     <p>${c.content}</p>
     ${imgsHtml}
    </div>`;
  });
 })
 .catch(()=>{
  // Fallback to static data if backend not available
  const p=DATA.find(x=>x.id===placeId);
  if(p && p.comments){
   commentList.innerHTML="";
   p.comments.forEach(c=>{
    commentList.innerHTML+=`
     <div class="comment">
      <b>${c.user}</b>
      <p>${c.text}</p>
     </div>`;
   });
  }
 });
}

function getCsrfToken(){
 const name = 'csrftoken';
 const value = `; ${document.cookie}`.split(`; ${name}=`)[1].split(';')[0];
 return value;
}

function submitComment(){
 const fd = new FormData();
 fd.append("csrfmiddlewaretoken", getCsrfToken());
 fd.append("display_name", document.getElementById("cName").value);
 fd.append("content", document.getElementById("cText").value);
 fd.append("price", document.getElementById("cPrice").value);
 fd.append("quality", document.getElementById("cQuality").value);
 fd.append("service", document.getElementById("cService").value);
 fd.append("space", document.getElementById("cSpace").value);
 fd.append("is_anonymous", document.getElementById("cAnon").checked);

 const imgFiles = document.getElementById("cImages").files;
 for(let i=0; i<imgFiles.length; i++){
  fd.append("images", imgFiles[i]);
 }

 fetch(`/comment/${currentPlaceId}/`,{
  method:"POST",
  body:fd
 })
 .then(r=>r.json())
 .then(d=>{
  if(d.success){
   alert("ƒê√£ g·ª≠i b√¨nh lu·∫≠n!");
   // Clear form
   document.getElementById("cName").value="";
   document.getElementById("cText").value="";
   document.getElementById("cImages").value="";
   // Reload comments
   loadComments(currentPlaceId);
  }else{
   alert("L·ªói: " + (d.error || ""));
  }
 })
 .catch(e=>{
  console.error(e);
  alert("C√≥ l·ªói x·∫£y ra!");
 });
}

detail.onclick=e=>{if(e.target===detail)detail.style.display="none"};
search.oninput=render;
render();
</script>

{% endblock %}
