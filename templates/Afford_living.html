{% extends "base.html" %}
{% load static %}
{% block content %}
<style>
    /* ===== BASE STYLES ===== */
    body { background: #f9fafb; color: #1f2937; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    
    /* ===== PIXEL TITLE ===== */
    .pixel-title {
        font-family: "Press Start 2P", monospace;
        text-align: center;
        font-size: 24px;
        margin-bottom: 30px;
    }

    /* ===== SEARCH BOX ===== */
    .search-section {
        max-width: 600px;
        margin: 0 auto 40px;
    }
    .search-box {
        position: relative;
    }
    .search-box input {
        width: 100%;
        padding: 16px 20px;
        font-size: 16px;
        border: 3px solid #000;
        border-radius: 8px;
        box-shadow: 4px 4px 0 #000;
        outline: none;
    }
    .search-box input:focus {
        box-shadow: 6px 6px 0 #10b981;
    }

    /* ===== FILTER TAGS ===== */
    .filter-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin-bottom: 30px;
    }
    .filter-tag {
        padding: 10px 20px;
        background: #fff;
        border: 3px solid #000;
        border-radius: 8px;
        font-family: monospace;
        font-size: 13px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 4px 4px 0 #000;
        transition: all 0.2s;
    }
    .filter-tag:hover {
        transform: translate(2px, 2px);
        box-shadow: 2px 2px 0 #000;
    }
    .filter-tag.active {
        background: #10b981;
        color: white;
        box-shadow: 2px 2px 0 #000;
    }

    /* ===== ACCOMMODATION GRID ===== */
    .accommodation-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 24px;
    }

    .accommodation-card {
        background: #fff;
        border: 3px solid #000;
        border-radius: 12px;
        box-shadow: 6px 6px 0 #000;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        color: inherit;
    }
    .accommodation-card:hover {
        transform: translate(-2px, -2px);
        box-shadow: 8px 8px 0 #000;
    }
    .accommodation-card img {
        width: 100%;
        height: 180px;
        object-fit: cover;
    }
    .card-image-placeholder {
        width: 100%;
        height: 180px;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
    }
    .accommodation-info {
        padding: 16px;
    }
    .accommodation-name {
        font-family: monospace;
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 8px;
    }
    .accommodation-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 12px;
    }
    .tag-badge {
        padding: 4px 8px;
        background: #e5e7eb;
        border: 2px solid #000;
        font-size: 11px;
        font-weight: bold;
    }
    .tag-badge.green { background: #10b981; color: white; }
    .tag-badge.blue { background: #3b82f6; color: white; }
    .tag-badge.orange { background: #f59e0b; color: white; }
    .accommodation-rating {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 12px;
        border-top: 2px solid #000;
        font-size: 13px;
        font-weight: bold;
    }
    .rating-stars {
        color: #f59e0b;
    }

    /* ===== OVERLAY/MODAL ===== */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
    }
    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background: #fff;
        border: 4px solid #000;
        border-radius: 16px;
        box-shadow: 8px 8px 0 #000;
        max-width: 1100px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        background: linear-gradient(to right, #10b981, #059669);
        color: white;
        padding: 24px;
    }
    .modal-header h2 {
        font-family: monospace;
        font-size: 24px;
        margin-bottom: 8px;
    }
    .modal-header a {
        color: white;
        text-decoration: underline;
    }
    .modal-close {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        background: rgba(0,0,0,0.3);
        border: 2px solid #fff;
        border-radius: 50%;
        color: white;
        font-size: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-body {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        padding: 24px;
    }
    @media (max-width: 768px) {
        .modal-body { grid-template-columns: 1fr; }
    }

    .detail-section h3 {
        font-family: monospace;
        font-size: 16px;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 2px solid #000;
    }

    /* ===== IMAGES ===== */
    .main-image {
        width: 100%;
        height: 250px;
        object-fit: cover;
        border: 3px solid #000;
        border-radius: 12px;
        margin-bottom: 12px;
    }
    .gallery {
        display: flex;
        gap: 10px;
        overflow-x: auto;
    }
    .gallery img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border: 2px solid #000;
        border-radius: 8px;
        cursor: pointer;
        flex-shrink: 0;
    }
    .gallery img:hover {
        border-color: #10b981;
    }

    /* ===== INFO GRID ===== */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
    }
    .info-item {
        background: #f3f4f6;
        border: 2px solid #000;
        border-radius: 8px;
        padding: 12px;
        text-align: center;
    }
    .info-label {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 4px;
    }
    .info-value {
        font-family: "Press Start 2P", monospace;
        font-size: 14px;
        font-weight: bold;
        color: #10b981;
    }

    /* ===== SCORES ===== */
    .scores-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
    }
    .score-item {
        background: #f3f4f6;
        border: 2px solid #000;
        border-radius: 8px;
        padding: 12px;
        text-align: center;
    }
    .score-label {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 4px;
    }
    .score-value {
        font-family: "Press Start 2P", monospace;
        font-size: 20px;
        font-weight: bold;
        color: #10b981;
    }
    .overall-score {
        background: #10b981;
        color: white;
        border: 3px solid #000;
        border-radius: 12px;
        padding: 16px;
        text-align: center;
        margin-bottom: 20px;
    }
    .overall-score .label {
        font-size: 12px;
        margin-bottom: 4px;
    }
    .overall-score .value {
        font-family: "Press Start 2P", monospace;
        font-size: 36px;
    }

    .amenities {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 20px;
    }
    .amenity {
        padding: 6px 12px;
        background: #10b981;
        color: white;
        border: 2px solid #000;
        border-radius: 6px;
        font-size: 12px;
        font-weight: bold;
    }

    .description {
        background: #f9fafb;
        border: 2px solid #000;
        border-radius: 8px;
        padding: 16px;
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 20px;
    }

    /* ===== REVIEWS ===== */
    .reviews-section h3 {
        font-family: monospace;
        font-size: 16px;
        margin-bottom: 16px;
    }
    .reviews-list {
        max-height: 400px;
        overflow-y: auto;
    }
    .review-item {
        background: #f9fafb;
        border: 2px solid #000;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 12px;
    }
    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    .review-user {
        font-weight: bold;
        font-family: monospace;
    }
    .review-rating {
        color: #f59e0b;
    }
    .review-content {
        font-size: 14px;
        line-height: 1.5;
    }
    .review-date {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 8px;
    }
    .review-scores {
        display: flex;
        gap: 12px;
        font-size: 11px;
        margin-top: 8px;
    }
    .review-score {
        background: #e5e7eb;
        padding: 4px 8px;
        border-radius: 4px;
    }
    .review-images {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        flex-wrap: wrap;
    }
    .review-images img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border: 2px solid #000;
        border-radius: 6px;
        cursor: pointer;
    }

    /* ===== REVIEW FORM ===== */
    .review-form {
        margin-top: 20px;
        padding: 20px;
        background: #f9fafb;
        border: 3px solid #000;
        border-radius: 12px;
        display: none;
    }
    .review-form.active {
        display: block;
    }
    .review-form h4 {
        font-family: monospace;
        margin-bottom: 16px;
    }
    .form-group {
        margin-bottom: 16px;
    }
    .form-group label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 8px;
    }
    .form-group input[type="text"],
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #000;
        border-radius: 6px;
        font-family: monospace;
    }
    .form-group textarea {
        resize: vertical;
        min-height: 100px;
    }
    
    .slider-group {
        margin-bottom: 16px;
    }
    .slider-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }
    .slider-value {
        font-family: "Press Start 2P", monospace;
        font-weight: bold;
        color: #10b981;
    }
    .slider-group input[type="range"] {
        width: 100%;
        height: 8px;
        border: 2px solid #000;
        border-radius: 4px;
        appearance: none;
        background: #e5e7eb;
    }
    .slider-group input[type="range"]::-webkit-slider-thumb {
        appearance: none;
        width: 20px;
        height: 20px;
        background: #10b981;
        border: 2px solid #000;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .submit-btn {
        width: 100%;
        padding: 14px;
        background: #10b981;
        color: white;
        border: 3px solid #000;
        border-radius: 8px;
        font-family: monospace;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 4px 4px 0 #000;
        transition: all 0.2s;
    }
    .submit-btn:hover {
        transform: translate(2px, 2px);
        box-shadow: 2px 2px 0 #000;
    }

    .toggle-form-btn {
        width: 100%;
        padding: 14px;
        background: #f3f4f6;
        color: #1f2937;
        border: 3px solid #000;
        border-radius: 8px;
        font-family: monospace;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 4px 4px 0 #000;
        transition: all 0.2s;
        margin-top: 16px;
    }
    .toggle-form-btn:hover {
        transform: translate(2px, 2px);
        box-shadow: 2px 2px 0 #000;
    }

    .action-btn {
        display: block;
        width: 100%;
        text-decoration: none;
        padding: 16px;
        background: #10b981;
        border: 3px solid #000;
        border-radius: 8px;
        font-family: monospace;
        font-size: 14px;
        font-weight: bold;
        color: white;
        cursor: pointer;
        box-sizing: border-box;
        box-shadow: 4px 4px 0 #000;
        transition: all 0.2s;
        text-align: center;
    }
    .action-btn:hover {
        transform: translate(2px, 2px);
        box-shadow: 2px 2px 0 #000;
    }

    /* ===== ZOOM ===== */
    .zoom-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }
    .zoom-overlay.active {
        display: flex;
    }
    .zoom-overlay img {
        max-width: 90%;
        max-height: 90%;
        border: 3px solid #fff;
    }

    /* ===== EMPTY STATE ===== */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #9ca3af;
    }
    .empty-state svg {
        width: 80px;
        height: 80px;
        margin-bottom: 16px;
    }

    /* ===== COST MODAL ===== */
    .cost-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        padding: 20px;
    }
    .cost-modal-overlay.active {
        display: flex;
    }
    .cost-modal-content {
        background: #fff;
        border: 4px solid #000;
        border-radius: 16px;
        box-shadow: 8px 8px 0 #000;
        max-width: 500px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
    }
    .cost-modal-header {
        background: linear-gradient(to right, #10b981, #059669);
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .cost-modal-header h3 {
        font-family: monospace;
        font-size: 18px;
        margin: 0;
    }
    .cost-modal-close {
        width: 36px;
        height: 36px;
        background: rgba(0,0,0,0.3);
        border: 2px solid #fff;
        border-radius: 50%;
        color: white;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .cost-modal-body {
        padding: 24px;
    }
    .cost-item {
        background: #f9fafb;
        border: 2px solid #000;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
    }
    .cost-item:last-child {
        margin-bottom: 0;
    }
    .cost-label {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 8px;
        font-weight: 500;
    }
    .cost-value {
        font-family: "Press Start 2P", monospace;
        font-size: 16px;
        font-weight: bold;
        color: #10b981;
    }
    .cost-note {
        font-size: 12px;
        color: #9ca3af;
        margin-top: 8px;
        font-style: italic;
    }
</style>

<div class="container">
    <h1 class="pixel-title">üè† T√åM N∆†I ·ªû G·∫¶N FPT</h1>

    <!-- SEARCH -->
    <div class="search-section">
        <div class="search-box">
            <input id="search" placeholder="T√¨m theo khu v·ª±c, t√™n... (VD: Ng≈© H√†nh S∆°n, qu·∫≠n 7)">
        </div>
    </div>

    <!-- FILTER TAGS -->
    <div class="filter-tags">
        <button class="filter-tag active" data-filter="all">T·∫•t c·∫£</button>
        <button class="filter-tag" data-filter="KTX">K√Ω t√∫c x√°</button>
        <button class="filter-tag" data-filter="phongtro">Ph√≤ng tr·ªç</button>
        <button class="filter-tag" data-filter="nha nguyen can">Nh√† nguy√™n cƒÉn</button>
        <button class="filter-tag" data-filter="quantrum">Qu·∫≠n Thanh Kh√™</button>
        <button class="filter-tag" data-filter="nguhanhson">Ng≈© H√†nh S∆°n</button>
        <button class="filter-tag" data-filter="hoakhue">H√≤a Kh√™</button>
    </div>

    <!-- ACCOMMODATION LIST -->
    <div class="accommodation-grid" id="accommodationList">
        <!-- Cards will be rendered here by JavaScript -->
    </div>
</div>

<!-- DETAIL MODAL -->
<div class="modal-overlay" id="detailModal">
    <div class="modal-content">
        <div class="modal-header">
            <button class="modal-close" onclick="closeModal()">√ó</button>
            <h2 id="dName"></h2>
        </div>
        
        <div class="modal-body">
            <!-- LEFT: Info & Images -->
            <div class="detail-section">
                <h3>üì∏ H√¨nh ·∫£nh</h3>
                <img id="dMain" class="main-image">
                <div class="gallery" id="dGallery"></div>

                <h3 style="margin-top: 20px">üìã Th√¥ng tin</h3>
                
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">üìç ƒê·ªãa ch·ªâ</div>
                        <div class="info-value" id="dAddress" style="font-size: 12px; font-family: monospace;"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">üöó Kho·∫£ng c√°ch</div>
                        <div class="info-value" id="dDistance"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">üìê Di·ªán t√≠ch</div>
                        <div class="info-value" id="dArea"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">üë• S·ªë ng∆∞·ªùi</div>
                        <div class="info-value" id="dCapacity"></div>
                    </div>
                </div>

                <div style="margin-top: 16px;">
                    <a id="dMap" class="action-btn" target="_blank">üó∫Ô∏è Xem tr√™n Google Maps</a>
                    <button class="action-btn" onclick="openCostDetail()">üí∞ Chi ph√≠</button>
                </div>

                <h3 style="margin-top: 20px">üìä ƒê√°nh gi√°</h3>
                <div class="overall-score">
                    <div class="label">ƒêi·ªÉm t·ªïng h·ª£p</div>
                    <div class="value" id="dOverall"></div>
                </div>
                
                <div class="scores-grid">
                    <div class="score-item">
                        <div class="score-label">Gi√°</div>
                        <div class="score-value" id="sPrice"></div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">V·ªã tr√≠</div>
                        <div class="score-value" id="sLocation"></div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">Ti·ªán nghi</div>
                        <div class="score-value" id="sAmenity"></div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">An ninh</div>
                        <div class="score-value" id="sSecurity"></div>
                    </div>
                </div>

                <h3>üè∑Ô∏è Ti·ªán √≠ch</h3>
                <div class="amenities" id="dAmenities"></div>

                <div class="description" id="dDescription"></div>
            </div>

            <!-- RIGHT: Reviews & Form -->
            <div class="detail-section reviews-section">
                <h3>üí¨ ƒê√°nh gi√° (<span id="reviewCount">0</span>)</h3>
                
                <div class="reviews-list" id="reviewList">
                    <p style="color: #9ca3af; text-align: center;">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o</p>
                </div>

                <button class="toggle-form-btn" onclick="toggleReviewForm()">
                    ‚úèÔ∏è Vi·∫øt ƒë√°nh gi√°
                </button>

                <!-- REVIEW FORM -->
                <div class="review-form" id="reviewForm">
                    <h4>Th√™m ƒë√°nh gi√° m·ªõi</h4>
                    {% csrf_token %}
                    <div class="form-group">
                        <label>T√™n c·ªßa b·∫°n</label>
                        <input type="text" id="cName" placeholder="Nh·∫≠p t√™n ho·∫∑c ·∫©n danh">
                    </div>
                    
                    <div class="slider-group">
                        <div class="slider-header">
                            <label>Gi√° ph√≤ng üí∞</label>
                            <span class="slider-value" id="sliderPrice">5</span>
                        </div>
                        <input type="range" id="cPrice" min="1" max="10" value="5" oninput="updateSlider('Price')">
                    </div>
                    
                    <div class="slider-group">
                        <div class="slider-header">
                            <label>V·ªã tr√≠ üìç</label>
                            <span class="slider-value" id="sliderLocation">5</span>
                        </div>
                        <input type="range" id="cLocation" min="1" max="10" value="5" oninput="updateSlider('Location')">
                    </div>
                    
                    <div class="slider-group">
                        <div class="slider-header">
                            <label>Ti·ªán nghi üè†</label>
                            <span class="slider-value" id="sliderAmenity">5</span>
                        </div>
                        <input type="range" id="cAmenity" min="1" max="10" value="5" oninput="updateSlider('Amenity')">
                    </div>
                    
                    <div class="slider-group">
                        <div class="slider-header">
                            <label>An ninh üîí</label>
                            <span class="slider-value" id="sliderSecurity">5</span>
                        </div>
                        <input type="range" id="cSecurity" min="1" max="10" value="5" oninput="updateSlider('Security')">
                    </div>
                    
                    <div class="form-group">
                        <label>N·ªôi dung ƒë√°nh gi√°</label>
                        <textarea id="cText" placeholder="Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n..." rows="4"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>·∫¢nh ƒë√≠nh k√®m (c√≥ th·ªÉ ch·ªçn nhi·ªÅu)</label>
                        <input type="file" id="cImages" multiple accept="image/*">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="cAnon"> ·∫®n danh
                        </label>
                    </div>
                    
                    <button class="submit-btn" onclick="submitReview()">üì§ G·ª≠i ƒë√°nh gi√°</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- COST DETAIL MODAL -->
<div class="cost-modal-overlay" id="costModal">
    <div class="cost-modal-content">
        <div class="cost-modal-header">
            <h3>üí∞ Chi ph√≠ chi ti·∫øt</h3>
            <button class="cost-modal-close" onclick="closeCostDetail()">√ó</button>
        </div>
        <div class="cost-modal-body">
            <div class="cost-item">
                <div class="cost-label">üè† Gi√° ph√≤ng</div>
                <div class="cost-value" id="costRoom"></div>
                <div class="cost-note">Gi√° tham kh·∫£o, c√≥ th·ªÉ thay ƒë·ªïi t√πy th·ªùi ƒëi·ªÉm</div>
            </div>
            <div class="cost-item">
                <div class="cost-label">üíß Ti·ªÅn n∆∞·ªõc</div>
                <div class="cost-value" id="costWater"></div>
                <div class="cost-note">Th∆∞·ªùng t√≠nh theo ƒë·∫ßu ng∆∞·ªùi ho·∫∑c theo s·ªë m¬≥</div>
            </div>
            <div class="cost-item">
                <div class="cost-label">‚ö° Ti·ªÅn ƒëi·ªán</div>
                <div class="cost-value" id="costElectric"></div>
                <div class="cost-note">Gi√° ƒëi·ªán sinh ho·∫°t ~3.000ƒë/kWh</div>
            </div>
            <div class="cost-item">
                <div class="cost-label">üì∂ Wifi/Internet</div>
                <div class="cost-value" id="costWifi"></div>
                <div class="cost-note">C√≥ th·ªÉ t√≠nh v√†o gi√° ph√≤ng ho·∫∑c ri√™ng</div>
            </div>
            <div class="cost-item">
                <div class="cost-label">üßπ D·ªãch v·ª• kh√°c</div>
                <div class="cost-value" id="costOther"></div>
                <div class="cost-note">R√°c th·∫£i, v·ªá sinh chung...</div>
            </div>
            <div class="cost-item" style="background: #10b981; color: white;">
                <div class="cost-label" style="color: white;">üíµ T·ªïng ∆∞·ªõc t√≠nh</div>
                <div class="cost-value" style="color: white;" id="costTotal"></div>
                <div class="cost-note" style="color: #d1fae5;">M·ªói ng∆∞·ªùi khi ·ªü gh√©p</div>
            </div>
        </div>
    </div>
</div>

<!-- ZOOM IMAGE -->
<div class="zoom-overlay" id="zoomOverlay" onclick="closeZoom()">
    <img id="zoomImg">
</div>

<script>
// Place data with ratings starting at 0
const DATA = [
    {
        id: 1,
        name: "Bobi House",
        map: "https://maps.google.com/?q=Bobi+House+FPT",
        type: "phongtro",
        address: "Ng≈© H√†nh S∆°n, ƒê√† N·∫µng",
        price: "2.6tr - 3tr",
        areaValue: "20-30m¬≤",
        distance: "800m",
        capacity: "1-2 ng∆∞·ªùi",
        keywords: ["bobi", "house", "ng≈© h√†nh s∆°n"],
        tags: ["Ph√≤ng tr·ªç", "Ng≈© H√†nh S∆°n"],
        amenities: ["Wifi", "ƒêi·ªÅu h√≤a", "N√≥ng l·∫°nh", "T·ªß l·∫°nh", "M√°y gi·∫∑t"],
        photos: {
            place: ["{% static 'image/living/1.jpg' %}"]
        },
        description: "Bobi House - Ph√≤ng tr·ªç g·∫ßn FPT, di chuy·ªÉn thu·∫≠n ti·ªán. Gi√° ph√≤ng h·ª£p l√Ω, ch·ªß nh√† th√¢n thi·ªán.",
        ratings: [],
        reviews: [],
        cost: {
            room: "2.6tr/ng∆∞·ªùi - 3tr/2 ng∆∞·ªùi",
            water: "50k/ng∆∞·ªùi",
            electric: "3.5k/ch·ªØ",
            wifi: "Mi·ªÖn ph√≠",
            other: "0ƒë",
            total: "~1.3tr - 1.5tr/ng∆∞·ªùi"
        }
    },
    {
        id: 2,
        name: "CƒÉn h·ªô ƒê√¨nh V≈©",
        map: "https://maps.google.com/?q=Dinh+Vu+Apartment+FPT",
        type: "canho",
        address: "Ng≈© H√†nh S∆°n, ƒê√† N·∫µng",
        price: "3.5tr",
        areaValue: "35-45m¬≤",
        distance: "1km",
        capacity: "2 ng∆∞·ªùi",
        keywords: ["ƒë√¨nh v≈©", "cƒÉn h·ªô", "ng≈© h√†nh s∆°n"],
        tags: ["CƒÉn h·ªô", "Ng≈© H√†nh S∆°n"],
        amenities: ["Wifi", "ƒêi·ªÅu h√≤a", "N√≥ng l·∫°nh", "T·ªß l·∫°nh", "M√°y gi·∫∑t", "Ban c√¥ng"],
        photos: {
            place: ["{% static 'image/living/2.jpg' %}"]
        },
        description: "CƒÉn h·ªô ƒê√¨nh V≈© - R·ªông r√£i, tho√°ng m√°t, g·∫ßn khu v·ª±c FPT. Ph√π h·ª£p cho 2 ng∆∞·ªùi ·ªü.",
        ratings: [],
        reviews: [],
        cost: {
            room: "3.5tr/2 ng∆∞·ªùi",
            water: "30k/ng∆∞·ªùi",
            electric: "3.5k/ch·ªØ",
            wifi: "Mi·ªÖn ph√≠",
            other: "0ƒë",
            total: "~1.75tr - 1.9tr/ng∆∞·ªùi"
        }
    },
    {
        id: 3,
        name: "T√®o FPT Apartment",
        map: "https://maps.google.com/?q=T√©o+FPT+Apartment",
        type: "canho",
        address: "Ng≈© H√†nh S∆°n, ƒê√† N·∫µng",
        price: "3.5tr",
        areaValue: "40-50m¬≤",
        distance: "1.2km",
        capacity: "3 ng∆∞·ªùi",
        keywords: ["t√®o", "fpt", "apartment", "ng≈© h√†nh s∆°n"],
        tags: ["CƒÉn h·ªô", "Ng≈© H√†nh S∆°n"],
        amenities: ["Wifi", "ƒêi·ªÅu h√≤a", "N√≥ng l·∫°nh", "T·ªß l·∫°nh", "M√°y gi·∫∑t", "B·∫øp"],
        photos: {
            place: ["{% static 'image/living/3.jpg' %}"]
        },
        description: "T√®o FPT Apartment - CƒÉn h·ªô r·ªông cho nh√≥m sinh vi√™n. G·∫ßn FPT, ti·ªán nghi ƒë·∫ßy ƒë·ªß.",
        ratings: [],
        reviews: [],
        cost: {
            room: "3.5tr/3 ng∆∞·ªùi",
            water: "50k/ng∆∞·ªùi",
            electric: "3.5k/ch·ªØ",
            wifi: "Mi·ªÖn ph√≠",
            other: "0ƒë",
            total: "~1.17tr - 1.3tr/ng∆∞·ªùi"
        }
    },
    {
        id: 4,
        name: "Caf√© An An",
        map: "https://maps.google.com/?q=Cafe+An+An+FPT",
        type: "phongtro",
        address: "Ng≈© H√†nh S∆°n, ƒê√† N·∫µng",
        price: "3tr - 4.5tr",
        areaValue: "25-35m¬≤",
        distance: "700m",
        capacity: "1-2 ng∆∞·ªùi",
        keywords: ["an an", "cafe", "ph√≤ng tr·ªç", "ng≈© h√†nh s∆°n"],
        tags: ["Ph√≤ng tr·ªç", "Ng≈© H√†nh S∆°n"],
        amenities: ["Wifi", "ƒêi·ªÅu h√≤a", "N√≥ng l·∫°nh", "T·ªß l·∫°nh", "M√°y gi·∫∑t"],
        photos: {
            place: ["{% static 'image/living/4.jpg' %}"]
        },
        description: "Caf√© An An - Ph√≤ng tr·ªç c√≥ qu√°n cafe b√™n d∆∞·ªõi. Kh√¥ng gian xanh m√°t, y√™n tƒ©nh.",
        ratings: [],
        reviews: [],
        cost: {
            room: "3tr/1 ng∆∞·ªùi - 4.5tr/2 ng∆∞·ªùi",
            water: "50k/ng∆∞·ªùi",
            electric: "3.5k/ch·ªØ",
            wifi: "Mi·ªÖn ph√≠",
            other: "0ƒë",
            total: "~1.5tr - 2.25tr/ng∆∞·ªùi"
        }
    },
    {
        id: 5,
        name: "DTT Apartment",
        map: "https://maps.google.com/?q=DTT+Apartment+FPT",
        type: "canho",
        address: "Ng≈© H√†nh S∆°n, ƒê√† N·∫µng",
        price: "4.5tr",
        areaValue: "45-55m¬≤",
        distance: "1km",
        capacity: "2 ng∆∞·ªùi",
        keywords: ["dtt", "apartment", "ng≈© h√†nh s∆°n"],
        tags: ["CƒÉn h·ªô", "Ng≈© H√†nh S∆°n"],
        amenities: ["Wifi", "ƒêi·ªÅu h√≤a", "N√≥ng l·∫°nh", "T·ªß l·∫°nh", "M√°y gi·∫∑t", "Ban c√¥ng", "B·∫øp"],
        photos: {
            place: ["{% static 'image/living/5.jpg' %}"]
        },
        description: "DTT Apartment - CƒÉn h·ªô cao c·∫•p g·∫ßn FPT. ƒê·∫ßy ƒë·ªß ti·ªán nghi, view ƒë·∫πp.",
        ratings: [],
        reviews: [],
        cost: {
            room: "4.5tr/2 ng∆∞·ªùi",
            water: "50k/ng∆∞·ªùi",
            electric: "3.5k/ch·ªØ",
            wifi: "Mi·ªÖn ph√≠",
            other: "0ƒë",
            total: "~2.25tr - 2.5tr/ng∆∞·ªùi"
        }
    },
    {
        id: 6,
        name: "Tr·ªç A Ph√∫c",
        map: "https://maps.google.com/?q=Tro+A+Phuc+FPT",
        type: "phongtro",
        address: "Thanh Kh√™, ƒê√† N·∫µng",
        price: "1.9tr",
        areaValue: "18-25m¬≤",
        distance: "2.5km",
        capacity: "1 ng∆∞·ªùi",
        keywords: ["a ph√∫c", "ph√∫c", "thanh kh√™", "tr·ªç"],
        tags: ["Ph√≤ng tr·ªç", "Thanh Kh√™"],
        amenities: ["Wifi", "ƒêi·ªÅu h√≤a", "N√≥ng l·∫°nh"],
        photos: {
            place: ["{% static 'image/living/6.jpg' %}"]
        },
        description: "Tr·ªç A Ph√∫c - Ph√≤ng tr·ªç gi√° r·∫ª, ph√π h·ª£p cho sinh vi√™n. ƒêi xe m√°y 15 ph√∫t t·ªõi FPT.",
        ratings: [],
        reviews: [],
        cost: {
            room: "1.9tr/ng∆∞·ªùi",
            water: "50k/ng∆∞·ªùi",
            electric: "3.5k/ch·ªØ",
            wifi: "Mi·ªÖn ph√≠",
            other: "0ƒë",
            total: "~2tr - 2.2tr/ng∆∞·ªùi"
        }
    },
    {
        id: 7,
        name: "B·∫£o Home 2",
        map: "https://maps.google.com/?q=Bao+Home+2+FPT",
        type: "canho",
        address: "Ng≈© H√†nh S∆°n, ƒê√† N·∫µng",
        price: "3.2tr",
        areaValue: "35-45m¬≤",
        distance: "900m",
        capacity: "2 ng∆∞·ªùi",
        keywords: ["b·∫£o home", "home 2", "ng≈© h√†nh s∆°n"],
        tags: ["CƒÉn h·ªô", "Ng≈© H√†nh S∆°n"],
        amenities: ["Wifi", "ƒêi·ªÅu h√≤a", "N√≥ng l·∫°nh", "T·ªß l·∫°nh", "M√°y gi·∫∑t", "B·∫øp"],
        photos: {
            place: ["{% static 'image/living/7.jpg' %}"]
        },
        description: "B·∫£o Home 2 - CƒÉn h·ªô m·ªõi, s·∫°ch s·∫Ω, g·∫ßn FPT. Ch·ªß nh√† th√¢n thi·ªán, h·ªó tr·ª£ sinh vi√™n.",
        ratings: [],
        reviews: [],
        cost: {
            room: "3.2tr/2 ng∆∞·ªùi",
            water: "70k/ng∆∞·ªùi",
            electric: "3.8k/ch·ªØ",
            wifi: "50k/ng∆∞·ªùi",
            other: "50k/ng∆∞·ªùi (r√°c)",
            total: "~1.6tr - 1.8tr/ng∆∞·ªùi"
        }
    }
];

let currentId = null;
let activeFilter = 'all';

function avg(p) {
    let t = {price: 0, location: 0, amenity: 0, security: 0};
    if (p.ratings && p.ratings.length > 0) {
        p.ratings.forEach(r => Object.keys(t).forEach(k => t[k] += r[k]));
        Object.keys(t).forEach(k => t[k] /= p.ratings.length);
    }
    return t;
}

function render() {
    const q = document.getElementById('search').value.toLowerCase();
    const container = document.getElementById('accommodationList');
    
    console.log('Rendering cards...');
    console.log('DATA length:', DATA.length);
    
    container.innerHTML = "";
    
    let filtered = DATA.filter(p => {
        if (activeFilter !== 'all') {
            if (activeFilter === 'KTX' && p.type !== 'KTX') return false;
            if (activeFilter === 'phongtro' && p.type !== 'phongtro') return false;
            if (activeFilter === 'nha nguyen can' && p.type !== 'nha nguyen can') return false;
            if (['quantrum', 'nguhanhson', 'hoakhue'].includes(activeFilter)) {
                if (!p.address.toLowerCase().includes(activeFilter === 'quantrum' ? 'thanh' : activeFilter === 'nguhanhson' ? 'ng≈©' : 'h√≤a')) return false;
            }
        }
        
        if (!q) return true;
        return p.name.toLowerCase().includes(q) ||
               p.address.toLowerCase().includes(q) ||
               p.tags.some(t => q.includes(t.toLowerCase())) ||
               p.keywords.some(k => q.includes(k));
    });
    
    console.log('Filtered count:', filtered.length);
    
    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <p>Kh√¥ng t√¨m th·∫•y n∆°i ·ªü ph√π h·ª£p</p>
            </div>
        `;
        return;
    }
    
    filtered.forEach(p => {
        const a = avg(p);
        const overall = ((a.price + a.location + a.amenity + a.security) / 4).toFixed(1);
        const reviewCount = p.reviews.length;
        const imgSrc = p.photos.place[0] || '';
        
        container.innerHTML += `
            <div class="accommodation-card" onclick="openDetail(${p.id})" style="min-height: 320px;">
                <div class="card-image-placeholder" style="width: 100%; height: 180px; background: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 48px;">
                    ${imgSrc ? `<img src="${imgSrc}" alt="${p.name}" style="width: 100%; height: 100%; object-fit: cover;">` : 'üè†'}
                </div>
                <div class="accommodation-info">
                    <div class="accommodation-name">${p.name}</div>
                    <div class="accommodation-tags">
                        ${p.tags.slice(0, 3).map(t => `<span class="tag-badge ${t === 'KTX' ? 'green' : t === 'Ph√≤ng tr·ªç' ? 'blue' : 'orange'}">${t}</span>`).join('')}
                    </div>
                    <div class="accommodation-rating">
                        <span class="rating-stars">‚≠ê ${overall}</span>
                        <span>${reviewCount} ƒë√°nh gi√°</span>
                    </div>
                </div>
            </div>
        `;
    });
    
    console.log('Cards rendered successfully');
}

function openDetail(id) {
    const p = DATA.find(x => x.id === id);
    currentId = id;
    
    const modal = document.getElementById('detailModal');
    
    const a = avg(p);
    const overall = ((a.price + a.location + a.amenity + a.security) / 4).toFixed(1);
    
    document.getElementById('dName').innerText = p.name;
    document.getElementById('dMap').href = p.map;
    document.getElementById('dAddress').innerText = p.address;
    document.getElementById('dArea').innerText = p.areaValue;
    document.getElementById('dDistance').innerText = p.distance;
    document.getElementById('dCapacity').innerText = p.capacity;
    document.getElementById('dDescription').innerText = p.description;
    
    // Show ratings
    document.getElementById('dOverall').innerText = overall + "/10";
    document.getElementById('sPrice').innerText = a.price.toFixed(1);
    document.getElementById('sLocation').innerText = a.location.toFixed(1);
    document.getElementById('sAmenity').innerText = a.amenity.toFixed(1);
    document.getElementById('sSecurity').innerText = a.security.toFixed(1);
    
    document.getElementById('dAmenities').innerHTML = p.amenities.map(a => `<span class="amenity">${a}</span>`).join('');
    
    const imgSrc = p.photos.place[0] || '';
    if (imgSrc) {
        document.getElementById('dMain').src = imgSrc;
        document.getElementById('dMain').style.display = 'block';
    } else {
        document.getElementById('dMain').style.display = 'none';
    }
    
    const gallery = document.getElementById('dGallery');
    gallery.innerHTML = "";
    p.photos.place.forEach((img, idx) => {
        gallery.innerHTML += `<img src="${img}" onclick="zoomImage('${img}')" ${idx === 0 ? 'style="border-color:#10b981"' : ''}>`;
    });
    
    document.getElementById('reviewCount').innerText = p.reviews.length;
    renderReviews(p.reviews);
    
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function renderReviews(reviews) {
    const container = document.getElementById('reviewList');
    if (!reviews || reviews.length === 0) {
        container.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 20px;">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o</p>';
        return;
    }
    
    container.innerHTML = reviews.map(r => {
        let imagesHtml = '';
        if (r.images && r.images.length > 0) {
            imagesHtml = `<div class="review-images">${r.images.map(img => `<img src="${img}" onclick="zoomImage('${img}')">`).join('')}</div>`;
        }
        
        const date = r.created_at ? new Date(r.created_at).toLocaleDateString('vi-VN') : (r.date || '');
        const scores = r.ratings || {price: r.price || 0, location: r.location || 0, amenity: r.amenity || 0, security: r.security || 0};
        
        return `
            <div class="review-item">
                <div class="review-header">
                    <span class="review-user">${r.user}</span>
                    <span class="review-date">${date}</span>
                </div>
                <div class="review-content">${r.content || r.text || ''}</div>
                <div class="review-scores">
                    <span class="review-score">üí∞ ${scores.price}</span>
                    <span class="review-score">üìç ${scores.location}</span>
                    <span class="review-score">üè† ${scores.amenity}</span>
                    <span class="review-score">üîí ${scores.security}</span>
                </div>
                ${imagesHtml}
            </div>
        `;
    }).join('');
}

function closeModal() {
    document.getElementById('detailModal').classList.remove('active');
    document.body.style.overflow = '';
    document.getElementById('reviewForm').classList.remove('active');
}

function toggleReviewForm() {
    document.getElementById('reviewForm').classList.toggle('active');
}

function updateSlider(type) {
    const val = document.getElementById('c' + type).value;
    document.getElementById('slider' + type).innerText = val;
}

function zoomImage(src) {
    document.getElementById('zoomImg').src = src;
    document.getElementById('zoomOverlay').classList.add('active');
}

function closeZoom() {
    document.getElementById('zoomOverlay').classList.remove('active');
}

function getCsrfToken() {
    const name = 'csrftoken';
    const value = `; ${document.cookie}`.split(`; ${name}=`)[1].split(';')[0];
    return value;
}

function submitReview() {
    const fd = new FormData();
    fd.append("csrfmiddlewaretoken", getCsrfToken());
    fd.append("display_name", document.getElementById("cName").value || "·∫®n danh");
    fd.append("content", document.getElementById("cText").value);
    fd.append("price", document.getElementById("cPrice").value);
    fd.append("location", document.getElementById("cLocation").value);
    fd.append("amenity", document.getElementById("cAmenity").value);
    fd.append("security", document.getElementById("cSecurity").value);
    fd.append("is_anonymous", document.getElementById("cAnon").checked);

    const imgFiles = document.getElementById("cImages").files;
    for(let i=0; i<imgFiles.length; i++){
        fd.append("images", imgFiles[i]);
    }

    fetch(`/living-comment/${currentId}/`, {
        method: "POST",
        body: fd
    })
    .then(r => r.json())
    .then(d => {
        if (d.success) {
            alert("ƒê√£ g·ª≠i ƒë√°nh gi√°!");
            document.getElementById("cName").value = "";
            document.getElementById("cText").value = "";
            document.getElementById("cImages").value = "";
            loadReviews(currentId);
            toggleReviewForm();
        } else {
            alert("L·ªói: " + (d.error || ""));
        }
    })
    .catch(() => {
        // Fallback: add review locally
        const p = DATA.find(x => x.id === currentId);
        const overall = (
            parseInt(document.getElementById("cPrice").value) +
            parseInt(document.getElementById("cLocation").value) +
            parseInt(document.getElementById("cAmenity").value) +
            parseInt(document.getElementById("cSecurity").value)
        ) / 4;
        
        const newReview = {
            user: document.getElementById("cName").value || "·∫®n danh",
            content: document.getElementById("cText").value,
            date: new Date().toISOString().split('T')[0],
            images: [],
            ratings: {
                price: parseInt(document.getElementById("cPrice").value),
                location: parseInt(document.getElementById("cLocation").value),
                amenity: parseInt(document.getElementById("cAmenity").value),
                security: parseInt(document.getElementById("cSecurity").value)
            }
        };
        if (p) {
            if (!p.ratings) p.ratings = [];
            if (!p.reviews) p.reviews = [];
            p.ratings.push(newReview.ratings);
            p.reviews.unshift(newReview);
        }
        renderReviews(p ? p.reviews : [newReview]);
        document.getElementById('reviewCount').innerText = p ? p.reviews.length : 1;
        alert("ƒê√£ g·ª≠i ƒë√°nh gi√°!");
        document.getElementById("cName").value = "";
        document.getElementById("cText").value = "";
        document.getElementById("cImages").value = "";
        toggleReviewForm();
        // Refresh the main page to show updated ratings
        render();
    });
}

function loadReviews(id) {
    fetch(`/living-comment/list/${id}/`)
    .then(r => r.json())
    .then(data => {
        const p = DATA.find(x => x.id === id);
        if (p) {
            p.reviews = data;
            p.ratings = data.map(c => c.ratings);
        }
        renderReviews(data);
        document.getElementById('reviewCount').innerText = data.length;
        // Refresh the main page to show updated ratings
        render();
    })
    .catch(() => {});
}

function openCostDetail() {
    const p = DATA.find(x => x.id === currentId);
    if (!p || !p.cost) return;
    
    document.getElementById('costRoom').innerText = p.cost.room;
    document.getElementById('costWater').innerText = p.cost.water;
    document.getElementById('costElectric').innerText = p.cost.electric;
    document.getElementById('costWifi').innerText = p.cost.wifi;
    document.getElementById('costOther').innerText = p.cost.other;
    document.getElementById('costTotal').innerText = p.cost.total;
    
    document.getElementById('costModal').classList.add('active');
}

function closeCostDetail() {
    document.getElementById('costModal').classList.remove('active');
}

// Filter buttons
document.querySelectorAll('.filter-tag').forEach(btn => {
    btn.onclick = function() {
        document.querySelectorAll('.filter-tag').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        activeFilter = this.dataset.filter;
        render();
    };
});

// Close modal on overlay click
document.getElementById('detailModal').onclick = function(e) {
    if (e.target === this) closeModal();
};

// Close cost modal on overlay click
document.getElementById('costModal').onclick = function(e) {
    if (e.target === this) closeCostDetail();
};

// Search listener
document.getElementById('search').oninput = render;

// Initial render
render();
console.log('Page loaded successfully');
</script>

{% endblock %}
